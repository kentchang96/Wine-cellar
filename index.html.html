<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wine Cellar</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --wine-deep: #4a1a1f;
      --wine-red: #8b1538;
      --wine-light: #c85a6e;
      --gold: #d4af37;
      --cream: #faf8f3;
      --gray: #6b6b6b;
      --gray-light: #e8e6e1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, var(--cream) 0%, #f5f1ea 100%);
      color: var(--wine-deep);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .header {
      background: linear-gradient(135deg, var(--wine-deep) 0%, var(--wine-red) 100%);
      padding: 20px 20px 25px;
      box-shadow: 0 4px 20px rgba(74, 26, 31, 0.3);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150%;
      height: 200%;
      background: radial-gradient(circle, rgba(212, 175, 55, 0.15) 0%, transparent 70%);
      animation: pulse 8s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.7; }
    }

    .header-content {
      position: relative;
      z-index: 1;
    }

    h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.5rem;
      font-weight: 300;
      color: var(--cream);
      letter-spacing: 2px;
      margin-bottom: 5px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.75rem;
      color: var(--gold);
      text-align: center;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 300;
    }

    .search-filter {
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid var(--gray-light);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .search-box {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--gray-light);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: 'Montserrat', sans-serif;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--wine-light);
      box-shadow: 0 0 0 3px rgba(200, 90, 110, 0.1);
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 5px;
      -webkit-overflow-scrolling: touch;
    }

    .filter-chips::-webkit-scrollbar {
      display: none;
    }

    .chip {
      padding: 6px 14px;
      background: var(--gray-light);
      border: none;
      border-radius: 20px;
      font-size: 0.8rem;
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
      color: var(--wine-deep);
      font-weight: 500;
    }

    .chip.active {
      background: var(--wine-red);
      color: white;
      transform: scale(1.05);
    }

    .wines-grid {
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wine-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wine-card:active {
      transform: scale(0.98);
    }

    .wine-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: linear-gradient(135deg, var(--gray-light) 0%, #f0eee9 100%);
      position: relative;
    }

    .wine-info {
      padding: 12px;
    }

    .wine-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--wine-deep);
      line-height: 1.3;
    }

    .wine-meta {
      font-size: 0.75rem;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .wine-rating {
      display: flex;
      gap: 2px;
      font-size: 0.85rem;
    }

    .star {
      color: var(--gold);
    }

    .star.empty {
      color: var(--gray-light);
    }

    .add-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--wine-red) 0%, var(--wine-deep) 100%);
      color: white;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 6px 24px rgba(139, 21, 56, 0.4);
      transition: all 0.3s ease;
      z-index: 100;
    }

    .add-button:active {
      transform: scale(0.95);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(74, 26, 31, 0.95);
      z-index: 1000;
      overflow-y: auto;
      animation: modalFade 0.3s ease;
    }

    @keyframes modalFade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      background: var(--cream);
      margin: 20px;
      border-radius: 16px;
      padding: 25px;
      max-width: 500px;
      margin: 40px auto;
      animation: modalSlide 0.4s ease;
    }

    @keyframes modalSlide {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--wine-deep);
    }

    .close-button {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: var(--gray);
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--wine-deep);
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-light);
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--wine-light);
      box-shadow: 0 0 0 3px rgba(200, 90, 110, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .photo-upload {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .photo-upload button {
      flex: 1;
      padding: 10px;
      background: white;
      border: 2px solid var(--wine-red);
      border-radius: 8px;
      color: var(--wine-red);
      font-family: 'Montserrat', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }

    .photo-upload button:active {
      background: var(--wine-red);
      color: white;
    }

    .photo-preview {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }

    .photo-preview.visible {
      display: block;
    }

    .rating-input {
      display: flex;
      gap: 5px;
      font-size: 1.5rem;
      flex-wrap: wrap;
    }

    .rating-input span {
      cursor: pointer;
      color: var(--gray-light);
      transition: all 0.2s ease;
      user-select: none;
      position: relative;
    }

    .rating-input span.filled {
      color: var(--gold);
    }

    .submit-button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--wine-red) 0%, var(--wine-deep) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }

    .submit-button:active {
      transform: scale(0.98);
    }

    .delete-button {
      width: 100%;
      padding: 12px;
      background: transparent;
      color: var(--wine-red);
      border: 2px solid var(--wine-red);
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .delete-button:active {
      background: var(--wine-red);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray);
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: var(--wine-deep);
    }

    .url-input-group {
      display: none;
    }

    .url-input-group.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>Wine Cellar</h1>
      <div class="subtitle">Personal Collection</div>
    </div>
  </div>

  <div class="search-filter">
    <input type="text" class="search-box" id="searchBox" placeholder="Search wines...">
    <div class="filter-chips">
      <button class="chip active" data-filter="all">All</button>
      <button class="chip" data-filter="Red">Red</button>
      <button class="chip" data-filter="White">White</button>
      <button class="chip" data-filter="Rosé">Rosé</button>
      <button class="chip" data-filter="Sparkling">Sparkling</button>
    </div>
  </div>

  <div class="wines-grid" id="winesGrid"></div>

  <button class="add-button" id="addButton">+</button>

  <div class="modal" id="wineModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Add Wine</h2>
        <button class="close-button" id="closeModal">&times;</button>
      </div>
      
      <form id="wineForm">
        <input type="hidden" id="wineId">
        
        <div class="form-group">
          <label>Photo</label>
          <div class="photo-upload">
            <button type="button" id="uploadPhotoBtn">Upload Photo</button>
            <button type="button" id="importPhotoBtn">Import from URL</button>
          </div>
          <input type="file" id="photoFile" accept="image/*" style="display: none;">
          <div class="url-input-group" id="urlInputGroup">
            <input type="url" id="photoUrl" placeholder="Enter image URL">
          </div>
          <img id="photoPreview" class="photo-preview" alt="Wine photo preview">
        </div>

        <div class="form-group">
          <label>Wine Name</label>
          <input type="text" id="wineName" required>
        </div>

        <div class="form-group">
          <label>Vintage</label>
          <input type="number" id="vintage" min="1900" max="2030" placeholder="e.g., 2018">
        </div>

        <div class="form-group">
          <label>Color</label>
          <select id="color" required>
            <option value="">Select color</option>
            <option value="Red">Red</option>
            <option value="White">White</option>
            <option value="Rosé">Rosé</option>
            <option value="Sparkling">Sparkling</option>
            <option value="Dessert">Dessert</option>
            <option value="Fortified">Fortified</option>
          </select>
        </div>

        <div class="form-group">
          <label>Type/Variety</label>
          <input type="text" id="type" placeholder="e.g., Cabernet Sauvignon, Chardonnay">
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="notes" placeholder="Tasting notes, occasion, food pairings..."></textarea>
        </div>

        <div class="form-group">
          <label>Personal Rating</label>
          <div class="rating-input" id="ratingInput">
            <span data-rating="1">★</span>
            <span data-rating="2">★</span>
            <span data-rating="3">★</span>
            <span data-rating="4">★</span>
            <span data-rating="5">★</span>
            <span data-rating="6">★</span>
            <span data-rating="7">★</span>
            <span data-rating="8">★</span>
            <span data-rating="9">★</span>
            <span data-rating="10">★</span>
          </div>
        </div>

        <button type="submit" class="submit-button" id="submitButton">Add to Collection</button>
        <button type="button" class="delete-button" id="deleteButton" style="display: none;">Delete Wine</button>
      </form>
    </div>
  </div>

  <script>
    // Storage using window.storage for persistence
    let wines = [];
    let currentRating = 0;
    let currentPhoto = '';
    let editingId = null;
    let currentFilter = 'all';

    // Initialize app
    async function init() {
      await loadWines();
      renderWines();
      setupEventListeners();
    }

    // Load wines from storage
    async function loadWines() {
      try {
        const keys = await window.storage.list('wine:');
        if (keys && keys.keys) {
          wines = [];
          for (const key of keys.keys) {
            const result = await window.storage.get(key);
            if (result && result.value) {
              wines.push(JSON.parse(result.value));
            }
          }
        }
      } catch (error) {
        console.log('Starting with empty collection');
        wines = [];
      }
    }

    // Save wine to storage
    async function saveWine(wine) {
      try {
        await window.storage.set(`wine:${wine.id}`, JSON.stringify(wine));
        return true;
      } catch (error) {
        console.error('Error saving wine:', error);
        alert('Failed to save wine. Please try again.');
        return false;
      }
    }

    // Delete wine from storage
    async function deleteWine(id) {
      try {
        await window.storage.delete(`wine:${id}`);
        return true;
      } catch (error) {
        console.error('Error deleting wine:', error);
        return false;
      }
    }

    // Render wines grid
    function renderWines() {
      const grid = document.getElementById('winesGrid');
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      
      let filteredWines = wines.filter(wine => {
        const matchesFilter = currentFilter === 'all' || wine.color === currentFilter;
        const matchesSearch = wine.name.toLowerCase().includes(searchTerm) ||
                            (wine.type && wine.type.toLowerCase().includes(searchTerm)) ||
                            (wine.notes && wine.notes.toLowerCase().includes(searchTerm));
        return matchesFilter && matchesSearch;
      });

      if (filteredWines.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2C11.5 2 11 2.19 10.59 2.59L2.59 10.59C1.8 11.37 1.8 12.63 2.59 13.41L10.59 21.41C11.37 22.2 12.63 22.2 13.41 21.41L21.41 13.41C22.2 12.63 22.2 11.37 21.41 10.59L13.41 2.59C13 2.19 12.5 2 12 2M12 4L20 12L12 20L4 12L12 4M7 13V15H17V13H7Z"/>
            </svg>
            <h2>${searchTerm ? 'No wines found' : 'Your cellar is empty'}</h2>
            <p>${searchTerm ? 'Try a different search' : 'Tap + to add your first wine'}</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filteredWines.map(wine => {
        let ratingHtml = '';
        for (let i = 1; i <= 10; i++) {
          if (wine.rating >= i) {
            ratingHtml += '★';
          } else {
            ratingHtml += '<span class="star empty">★</span>';
          }
        }
        
        return `
          <div class="wine-card" data-id="${wine.id}">
            <img src="${wine.photo || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 200 200\'%3E%3Crect fill=\'%23f0eee9\' width=\'200\' height=\'200\'/%3E%3Cpath fill=\'%23d4af37\' opacity=\'0.2\' d=\'M100 40 L110 100 L100 160 L90 100 Z\'/%3E%3C/svg%3E'}" 
                 class="wine-image" alt="${wine.name}">
            <div class="wine-info">
              <div class="wine-name">${wine.name}</div>
              <div class="wine-meta">${wine.vintage ? wine.vintage + ' • ' : ''}${wine.color}${wine.type ? ' • ' + wine.type : ''}</div>
              <div class="wine-rating">
                ${ratingHtml}
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Add click listeners to cards
      document.querySelectorAll('.wine-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = parseInt(card.dataset.id);
          openEditModal(id);
        });
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Add button
      document.getElementById('addButton').addEventListener('click', openAddModal);

      // Close modal
      document.getElementById('closeModal').addEventListener('click', closeModal);

      // Photo upload buttons
      document.getElementById('uploadPhotoBtn').addEventListener('click', () => {
        document.getElementById('photoFile').click();
        document.getElementById('urlInputGroup').classList.remove('active');
      });

      document.getElementById('importPhotoBtn').addEventListener('click', () => {
        const urlGroup = document.getElementById('urlInputGroup');
        urlGroup.classList.toggle('active');
      });

      document.getElementById('photoFile').addEventListener('change', handleFileUpload);
      document.getElementById('photoUrl').addEventListener('input', handleUrlInput);

      // Rating stars
      document.querySelectorAll('#ratingInput span').forEach(star => {
        star.addEventListener('click', (e) => {
          currentRating = parseInt(e.target.dataset.rating);
          updateRatingDisplay();
        });
      });

      // Form submit
      document.getElementById('wineForm').addEventListener('submit', handleSubmit);

      // Delete button
      document.getElementById('deleteButton').addEventListener('click', handleDelete);

      // Search
      document.getElementById('searchBox').addEventListener('input', renderWines);

      // Filter chips
      document.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
          document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          e.target.classList.add('active');
          currentFilter = e.target.dataset.filter;
          renderWines();
        });
      });

      // Close modal on background click
      document.getElementById('wineModal').addEventListener('click', (e) => {
        if (e.target.id === 'wineModal') closeModal();
      });
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          currentPhoto = e.target.result;
          const preview = document.getElementById('photoPreview');
          preview.src = currentPhoto;
          preview.classList.add('visible');
        };
        reader.readAsDataURL(file);
      }
    }

    function handleUrlInput(e) {
      const url = e.target.value.trim();
      if (url) {
        currentPhoto = url;
        const preview = document.getElementById('photoPreview');
        preview.src = url;
        preview.classList.add('visible');
      }
    }

    function updateRatingDisplay() {
      document.querySelectorAll('#ratingInput span').forEach((star, index) => {
        const starValue = parseInt(star.dataset.rating);
        star.classList.remove('filled');
        
        if (currentRating >= starValue) {
          star.classList.add('filled');
        }
      });
    }

    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Wine';
      document.getElementById('submitButton').textContent = 'Add to Collection';
      document.getElementById('deleteButton').style.display = 'none';
      document.getElementById('wineForm').reset();
      document.getElementById('photoPreview').classList.remove('visible');
      currentRating = 0;
      currentPhoto = '';
      updateRatingDisplay();
      document.getElementById('wineModal').classList.add('active');
    }

    function openEditModal(id) {
      const wine = wines.find(w => w.id === id);
      if (!wine) return;

      editingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Wine';
      document.getElementById('submitButton').textContent = 'Update Wine';
      document.getElementById('deleteButton').style.display = 'block';
      
      document.getElementById('wineName').value = wine.name;
      document.getElementById('vintage').value = wine.vintage || '';
      document.getElementById('color').value = wine.color;
      document.getElementById('type').value = wine.type || '';
      document.getElementById('notes').value = wine.notes || '';
      
      currentRating = wine.rating;
      currentPhoto = wine.photo;
      updateRatingDisplay();
      
      if (wine.photo) {
        document.getElementById('photoPreview').src = wine.photo;
        document.getElementById('photoPreview').classList.add('visible');
      }
      
      document.getElementById('wineModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('wineModal').classList.remove('active');
      document.getElementById('urlInputGroup').classList.remove('active');
    }

    async function handleSubmit(e) {
      e.preventDefault();

      const wine = {
        id: editingId || Date.now(),
        name: document.getElementById('wineName').value,
        vintage: document.getElementById('vintage').value,
        color: document.getElementById('color').value,
        type: document.getElementById('type').value,
        notes: document.getElementById('notes').value,
        rating: currentRating,
        photo: currentPhoto,
        dateAdded: editingId ? wines.find(w => w.id === editingId).dateAdded : new Date().toISOString()
      };

      const saved = await saveWine(wine);
      if (saved) {
        if (editingId) {
          const index = wines.findIndex(w => w.id === editingId);
          wines[index] = wine;
        } else {
          wines.push(wine);
        }
        renderWines();
        closeModal();
      }
    }

    async function handleDelete() {
      if (!editingId) return;
      
      if (confirm('Are you sure you want to delete this wine?')) {
        const deleted = await deleteWine(`wine:${editingId}`);
        if (deleted) {
          wines = wines.filter(w => w.id !== editingId);
          renderWines();
          closeModal();
        }
      }
    }

    // Initialize app
    init();
  </script>
</body>
</html>
